<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Analyse de Texte Interactive par Partition</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* --- Generelt Layout --- */
		@font-face {
			font-family: myLato;
			 src: url(font/Lato-Regular.woff); 
			}
			
        body {
            font-family: myLato, sans-serif;
            display: flex;
            flex-direction: column;
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }
        #header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: #f8f8f8;
            border-bottom: 1px solid #ddd;
        }
        #controls {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 20px 20px;
            background: #f8f8f8;
        }
        #container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        /* --- Venstre Kolonne (Ordliste) --- */
        #word-list {
            width: 300px;
            overflow-y: scroll;
            border-right: 1px solid #ddd;
            padding: 10px;
            background: #fff;
            flex-shrink: 0;
        }
        .word-item {
            cursor: pointer;
            padding: 4px 8px;
            margin-bottom: 2px;
            border-radius: 3px;
            white-space: nowrap;
        }
        .word-item:hover, .word-item.selected {
            background-color: #e6e6ff;
            color: #333;
            font-weight: bold;
        }
		.word-item:nth-child(even) {
			background-color:DeepSkyBlue;
		}
		
        /* --- Hovedindhold (Faner) --- */
        #main-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #tab-bar {
            display: flex;
            border-bottom: 1px solid #ddd;
            padding-left: 20px;
            background: #f0f0f0;
        }
        .tab-link {
            padding: 10px 15px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-bottom: -1px;
            transition: background-color 0.2s;
        }
        .tab-link:hover {
            background-color: #e0e0e0;
        }
        .tab-link.active {
            background-color: #fff;
            border: 1px solid #ddd;
            border-bottom: 1px solid #fff;
        }
        #tab-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #fff;
        }
        .tab-pane {
            display: none;
        }
        .tab-pane.active {
            display: block;
        }

        /* --- Barchart Styling --- */
        #chart-title {
            text-align: center;
        }
        .bar {
            fill: steelblue;
        }
        .axis path, .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }
        .axis-label {
            font-size: 14px;
        }

        /* --- Konkordans (Kontekst) Styling --- */
        #concordance-list {
            font-family: monospace;
            white-space: pre-wrap;
            line-height: 1.5;
            font-size: 14px;
        }
        .concordance-line {
            padding: 2px 0;
            border-bottom: 1px dotted #eee;
        }
        .highlight {
            color: white;
            background-color: blue;
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: bold;
        }

        /* --- Sprogv√¶lger (Flags) --- */
        #language-selector {
            display: flex;
            gap: 10px;
        }
        .flag {
            cursor: pointer;
            width: 30px;
            height: 20px; 
            border: 1px solid #ccc;
            opacity: 0.5;
            transition: opacity 0.2s;
            line-height: 20px;
            text-align: center;
            font-size: 20px;
        }
        .flag:hover, .flag.selected {
            opacity: 1;
            border: 1px solid #333;
        }

        /* --- H√∏jre Panel Styling --- */
        #right-panel {
            position: absolute;
            top: 0;
            right: -385px; /* Skjult uden for sk√¶rmen */
            width: 350px;
            height: 100%;
            background: lightgrey;
            border-left: 1px solid #ddd;
            transition: right 2s ease-in-out;
            z-index: 100;
            overflow-y: auto;
            padding: 20px;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }
        
        #right-panel.open {
			
            right: 0; /* Synlig p√• sk√¶rmen */
        }
        
        #panel-trigger-area {
            position: absolute;
            top: 0;
            right: 0;
            width: 20px;
            height: 100%;
            background: transparent;
            cursor: ew-resize;
			
            z-index: 90;
        }
        
        #panel-trigger-area:hover ~ #right-panel,
        #right-panel:hover {
            right: 0;
        }
        
        .panel-toggle-btn {
            background: none;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }
        
        .panel-toggle-btn:hover {
            background: #e6e6ff;
            border-color: #999;
        }
        
        .right-panel-content {
            margin-top: 20px;
        }
        
        .right-panel-section {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .right-panel-section h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
        }
        
        .right-panel-section p {
            margin: 5px 0;
            font-size: 14px;
            line-height: 1.4;
        }
		
		/* --- Sprogv√¶lger (Flags) som Burger Menu --- */
		#burger-container {
			position: relative; /* Container for knap og menu */
			z-index: 200;
		}
		#burger-btn {
			/* Style for selve burger-ikonet */
			background: none; 
			border: 1px solid #ccc;
			border-radius: 4px;
			padding: 8px 12px;
			cursor: pointer;
			font-size: 16px;
			transition: all 0.2s;
		}
		#burger-btn:hover {
			background: #e6e6ff;
			border-color: #999;
		}

		#language-selector {
			/* Menuens standard position og skjulning (position: absolute er n√∏glen) */
			display: flex; /* Behold flex, men stak elementer */
			flex-direction: column; /* Placer flagene under hinanden */
			gap: 10px;
			position: absolute;
			top: 100%; /* Placeres under knappen */
			right: 0;
			background: #fff;
			border: 1px solid #ddd;
			box-shadow: 0 4px 6px rgba(0,0,0,0.1);
			padding: 10px;
			min-width: 100px;
			
			/* Skjul menuen med transition for en glidende effekt */
			visibility: hidden;
			opacity: 0;
			transform: translateY(-10px);
			transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
		}

		#language-selector.menu-open {
			/* Vis menuen */
			visibility: visible;
			opacity: 1;
			transform: translateY(0);
		}

		.flag {
			/* Sikrer, at flagene fylder hele bredden af menuen */
			display: flex;
			justify-content: center;
			align-items: center;
			/* ... eksisterende flag styling ... */
		}
    </style>
</head>
<body>

    <div id="header">
        <h2 id="app-title"></h2>
        <div id="burger-container">
			<button id="burger-btn" class="panel-toggle-btn">‚ò∞</button>
			<div id="language-selector"> 
				<span class="flag" data-lang="fr">üá´üá∑</span>
				<span class="flag" data-lang="en">üá¨üáß</span>
				<span class="flag" data-lang="da">üá©üá∞</span>
			</div>
		</div>
    </div>
    
    <div id="controls">
        <input type="file" id="fileInput" accept=".txt">
        
        <p id="status"></p>
    </div>

    <div id="container">
        <div id="word-list">
            <p></p>
        </div>
        
        <div id="main-view">
            <div id="tab-bar">
                <a class="tab-link active" data-tab="chart-tab"></a>
                <a class="tab-link" data-tab="context-tab"></a>
            </div>
            <div id="tab-content">
                <div id="chart-tab" class="tab-pane active">
                    <h3 id="chart-title"></h3>
                    <div style="text-align: center;">
                        <svg id="barchart"></svg>
                    </div>
                </div>
                <div id="context-tab" class="tab-pane">
                    <h3 id="concordance-title"></h3>
                    <div id="concordance-list"></div>
                </div>
            </div>
        </div>
        
        <!-- Trigger omr√•de for at tr√¶kke panelet frem med musen -->
        <div id="panel-trigger-area"></div>
        
        <!-- H√∏jre panel -->
        <div id="right-panel">
            <h3>Analysis Panel</h3>
            <div class="right-panel-content">
                <div class="right-panel-section">
                    <h4>File Information</h4>
                    <p id="panel-file-info">No file loaded</p>
                    <p id="panel-word-count">Total words: 0</p>
                    <p id="panel-partition-count">Partitions: 0</p>
                </div>
                
                <div class="right-panel-section">
                    <h4>Current Selection</h4>
                    <p id="panel-selected-word">No word selected</p>
                    <p id="panel-word-frequency">Frequency: 0</p>
                    <p id="panel-partition-distribution">Distribution: -</p>
                </div>
                
                <div class="right-panel-section">
                    <h4>Statistics</h4>
                    <p id="panel-total-words">Total unique words: 0</p>
                    <p id="panel-most-frequent">Most frequent word: -</p>
                    <p id="panel-analysis-time">Analysis time: -</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. INTERNATIONALISERING (i18n) GLOSSARY ---
        const glossary = {
            'fr': { // Fran√ßais (Default)
                'appTitle': 'Analyse de Texte Interactive',
                'filePrompt': 'Veuillez s√©lectionner un fichier texte (.txt) pour d√©marrer l\'analyse.',
                'loadingFile': 'Chargement du fichier : ',
                'analysisComplete': 'Analyse termin√©e. {0} mots uniques trouv√©s dans {1} partitions.',
                'listPlaceholder': 'Veuillez charger un fichier.',
                'tab1': 'D√©compte par Partition',
                'tab2': 'Affichage en Contexte',
                'chartPlaceholder': 'Cliquez sur un mot dans la liste pour voir sa distribution.',
                'chartTitlePrefix': 'Distribution du mot :',
                'concordanceTitle': 'Occurrences du mot en contexte:',
                'contextPlaceholder': 'S√©lectionnez un mot pour voir son contexte.',
                'yAxisLabel': 'Nombre d\'occurrences par partition',
                'wordListTitle': 'Mots (Fr√©quence globale)',
                'introPartition': 'INTRO',
                'panelTitle': 'Panneau d\'Analyse',
                'panelToggle': 'üìä Panneau',
                'fileInfo': 'Information Fichier',
                'currentSelection': 'S√©lection Actuelle',
                'statistics': 'Statistiques',
                'noFileLoaded': 'Aucun fichier charg√©',
                'totalWords': 'Mots totaux:',
                'partitions': 'Partitions:',
                'noWordSelected': 'Aucun mot s√©lectionn√©',
                'frequency': 'Fr√©quence:',
                'distribution': 'Distribution:',
                'totalUniqueWords': 'Mots uniques totaux:',
                'mostFrequentWord': 'Mot le plus fr√©quent:',
                'analysisTime': 'Temps d\'analyse:'
            },
            'en': {
                'appTitle': 'Interactive Text Analysis',
                'filePrompt': 'Please select a text file (.txt) to start the analysis.',
                'loadingFile': 'Loading file: ',
                'analysisComplete': 'Analysis complete. {0} unique words found in {1} partitions.',
                'listPlaceholder': 'Please load a file.',
                'tab1': 'Count per Partition',
                'tab2': 'Context View',
                'chartPlaceholder': 'Click on a word in the list to see its distribution.',
                'chartTitlePrefix': 'Word distribution:',
                'concordanceTitle': 'Word occurrences in context:',
                'contextPlaceholder': 'Select a word to view its context.',
                'yAxisLabel': 'Number of occurrences per partition',
                'wordListTitle': 'Words (Global Frequency)',
                'introPartition': 'INTRO',
                'panelTitle': 'Analysis Panel',
                'panelToggle': 'üìä Panel',
                'fileInfo': 'File Information',
                'currentSelection': 'Current Selection',
                'statistics': 'Statistics',
                'noFileLoaded': 'No file loaded',
                'totalWords': 'Total words:',
                'partitions': 'Partitions:',
                'noWordSelected': 'No word selected',
                'frequency': 'Frequency:',
                'distribution': 'Distribution:',
                'totalUniqueWords': 'Total unique words:',
                'mostFrequentWord': 'Most frequent word:',
                'analysisTime': 'Analysis time:'
            },
            'da': {
                'appTitle': 'Interaktiv Tekstanalyse',
                'filePrompt': 'V√¶lg venligst en tekstfil (.txt) for at starte analysen.',
                'loadingFile': 'Indl√¶ser fil: ',
                'analysisComplete': 'Analyse fuldf√∏rt. {0} unikke ord fundet i {1} partitioner.',
                'listPlaceholder': 'Indl√¶s venligst en fil.',
                'tab1': 'Opt√¶lling af ord pr partition',
                'tab2': 'Visning af ord i kontekst',
                'chartPlaceholder': 'Klik p√• et ord i listen for at se dets fordeling.',
                'chartTitlePrefix': 'Fordeling af ordet:',
                'concordanceTitle': 'Forekomster af ordet i kontekst:',
                'contextPlaceholder': 'V√¶lg et ord for at se dets kontekst.',
                'yAxisLabel': 'Antal forekomster pr. partition',
                'wordListTitle': 'Ord (Global frekvens)',
                'introPartition': 'INTRO',
                'panelTitle': 'Analysepanel',
                'panelToggle': 'üìä Panel',
                'fileInfo': 'Filinformation',
                'currentSelection': 'Nuv√¶rende Valg',
                'statistics': 'Statistikker',
                'noFileLoaded': 'Ingen fil indl√¶st',
                'totalWords': 'Totale ord:',
                'partitions': 'Partitioner:',
                'noWordSelected': 'Intet ord valgt',
                'frequency': 'Frekvens:',
                'distribution': 'Fordeling:',
                'totalUniqueWords': 'Totale unikke ord:',
                'mostFrequentWord': 'Mest hyppige ord:',
                'analysisTime': 'Analysetid:'
            }
        };
        
        let currentLang = 'fr'; // Fransk er standard
        let analysisData = {}; // Global datastruktur
        let globalTokenizedText = []; // Global liste til Konkordans
        let currentFileName = ''; // Gem filnavn for panel
        let analysisStartTime = 0; // Til at m√•le analysetid

        // Funktion til dynamisk at hente og inds√¶tte gloser
        function getGlose(key, ...params) {
            let text = glossary[currentLang][key] || glossary['fr'][key] || `MISSING_GLOSSARY_KEY: ${key}`;
            params.forEach((param, index) => {
                text = text.replace(`{${index}}`, param);
            });
            return text;
        }

        // Funktion til at opdatere alle UI tekster
        function updateUI() {
            document.title = getGlose('appTitle');
            document.getElementById('app-title').textContent = getGlose('appTitle');
            document.getElementById('status').textContent = getGlose('filePrompt');
            if(document.getElementById('word-list').querySelector('h4')!=null){
				document.getElementById('word-list').querySelector('h4').innerHTML = getGlose('listPlaceholder');
				document.getElementById('status').textContent =""
				}
			else
				document.getElementById('status').textContent = getGlose('filePrompt');
            
            // Opdater fanenavne
            document.querySelector('.tab-link[data-tab="chart-tab"]').textContent = getGlose('tab1');
            document.querySelector('.tab-link[data-tab="context-tab"]').textContent = getGlose('tab2');

            // Opdater Y-aksens label (hvis chart er initialiseret)
            d3.select(".y-axis-label").text(getGlose('yAxisLabel'));

            // Opdater titler i faner
            document.getElementById('chart-title').textContent = getGlose('chartPlaceholder');
            document.getElementById('concordance-title').textContent = getGlose('concordanceTitle');
            document.getElementById('concordance-list').innerHTML = `<p>${getGlose('contextPlaceholder')}</p>`;

            const wordListTitle = document.getElementById('word-list').querySelector('h4');
            if (wordListTitle) wordListTitle.textContent = getGlose('wordListTitle');

            // Opdater valgt flag
            document.querySelectorAll('.flag').forEach(flag => {
                flag.classList.remove('selected');
                if (flag.dataset.lang === currentLang) {
                    flag.classList.add('selected');
                }
            });
            
            // Opdater h√∏jre panel tekster
            updateRightPanelTexts();
        }
        
        // --- 2. D3.js Initialisering og Globaler ---
        
        // **FEJL RETTELSE:** Margin erkl√¶res f√∏r brug.
        const margin = { top: 20, right: 30, bottom: 80, left: 60 };
        const w_chart = 600; 
        const h_chart = 400; 

        const fileInput = document.getElementById('fileInput');
        
        // D3 SVG-ops√¶tning
        const svg = d3.select("#barchart")
            .attr("width", w_chart + margin.left + margin.right)
            .attr("height", h_chart + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        let x, y, xAxis, yAxis;
        
        function initializeChart() {
            x = d3.scaleBand().range([0, w_chart]).padding(0.1);
            y = d3.scaleLinear().range([h_chart, 0]);

            xAxis = svg.append("g")
                .attr("class", "x-axis axis")
                .attr("transform", `translate(0,${h_chart})`);

            yAxis = svg.append("g")
                .attr("class", "y-axis axis");
            
            svg.append("text")
                .attr("class", "y-axis-label axis-label")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (h_chart / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text(getGlose('yAxisLabel')); 
        }

        // --- 3. Dataanalyse og Visualisering ---
        
        // Global funktion til at rense ord til t√¶lling
        function cleanWord(word) {
            // Fjerner alt undtagen bogstaver, tal, og apostrof
            return word.replace(/[^a-z√¶√∏√•A-Z√Ü√ò√Ö0-9']/g, '').toLowerCase();
        }

        function runAnalysis(text) {
            analysisStartTime = performance.now();
            
            // 1. Tokenisering for Konkordans: Bevarer ordets originale form og r√¶kkef√∏lge
            // Matches ord ([a-z√¶√∏√•A-Z√Ü√ò√Ö0-9']+) ELLER ikke-ord (alt andet end mellemrum) separat
            const tokenRegex = /([a-z√¶√∏√•A-Z√Ü√ò√Ö0-9']+|[^a-z√¶√∏√•A-Z√Ü√ò√Ö0-9'\s]+)/g;
            const cleanTextForConcordance = text.replace(/<[^>]*>/g, ' '); // Fjern kun tags f√∏r tokenisering
            const rawTokens = cleanTextForConcordance.match(tokenRegex) || [];

            globalTokenizedText = rawTokens.map(token => ({
                word: cleanWord(token), // Rengjort for match
                raw: token // Original form til visning
            }));
            
            // 2. Partitionering for Barchart: Samme som f√∏r
            const partitionRegex = /(<[^>]*>)/g;
            const segments = text.split(partitionRegex).filter(s => s.trim().length > 0);

            let currentPartition = getGlose('introPartition');
            const partitionContents = {};

            segments.forEach(segment => {
                if (segment.match(partitionRegex)) {
                    currentPartition = segment.slice(1, -1).trim();
                } else {
                    partitionContents[currentPartition] = (partitionContents[currentPartition] || "") + " " + segment;
                }
            });

            const globalWordFrequencies = new Map();
            const partitionWordFrequencies = {};
            const partitionIds = Object.keys(partitionContents);

            partitionIds.forEach(pId => {
                const words = partitionContents[pId].split(/\s+/).map(cleanWord).filter(w => w.length > 0);
                partitionWordFrequencies[pId] = new Map();

                words.forEach(word => {
                    partitionWordFrequencies[pId].set(word, (partitionWordFrequencies[pId].get(word) || 0) + 1);
                    globalWordFrequencies.set(word, (globalWordFrequencies.get(word) || 0) + 1);
                });
            });

            // Sorter global liste
            const sortedGlobalWords = Array.from(globalWordFrequencies.entries());
            sortedGlobalWords.sort((a, b) => {
                const frequencyDiff = b[1] - a[1];
                if (frequencyDiff !== 0) return frequencyDiff;
                return a[0].localeCompare(b[0]);
            });

            // Gem data
            analysisData = {
                globalList: sortedGlobalWords,
                partitions: partitionWordFrequencies,
                partitionIds: partitionIds
            };

            displayWordList(analysisData.globalList);
            document.getElementById('status').textContent = getGlose('analysisComplete', sortedGlobalWords.length, partitionIds.length);
            
            // Opdater h√∏jre panel med analyseresultater
            updateRightPanelWithAnalysis();
        }

        // --- Visualisering: Ordliste og Barchart (fra tidligere) ---

        function displayWordList(sortedList) {
            const listDiv = d3.select("#word-list");
            listDiv.html(`<h4 style="margin-top: 0;">${getGlose('wordListTitle')}</h4>`); 

            listDiv.selectAll(".word-item")
                .data(sortedList)
                .join("div")
                .attr("class", "word-item")
                .text(d => `${d[0]} (${d[1]})`)
                .on("click", (event, d) => {
                    const word = d[0];
                    d3.selectAll('.word-item').classed('selected', false);
                    d3.select(event.currentTarget).classed('selected', true);
                    
                    // Opdater begge faner ved klik
                    updateBarchart(word);
                    updateConcordance(word);
                    
                    // Opdater h√∏jre panel med valgt ord
                    updateRightPanelWithSelectedWord(word, d[1]);
                });
        }

        function updateBarchart(word) {
            document.getElementById('chart-title').textContent = `${getGlose('chartTitlePrefix')} "${word}"`;

            const chartData = analysisData.partitionIds.map(pId => {
                const count = analysisData.partitions[pId].get(word) || 0;
                return { partition: pId, count: count };
            });

            x.domain(chartData.map(d => d.partition));
            y.domain([0, d3.max(chartData, d => d.count) * 1.05]);

            xAxis.transition().duration(500).call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end");

            yAxis.transition().duration(500).call(d3.axisLeft(y).ticks(5).tickFormat(d3.format("d")));

            const bars = svg.selectAll(".bar").data(chartData, d => d.partition);
            bars.exit().remove();

            bars.enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.partition))
                .attr("y", h_chart) 
                .attr("width", x.bandwidth())
                .attr("height", 0) 
                .merge(bars)
                .transition().duration(500)
                .attr("x", d => x(d.partition))
                .attr("y", d => y(d.count))
                .attr("width", x.bandwidth())
                .attr("height", d => h_chart - y(d.count));
            
            const labels = svg.selectAll(".bar-label").data(chartData, d => d.partition);
            labels.exit().remove();

            labels.enter().append("text")
                .attr("class", "bar-label")
                .attr("text-anchor", "middle")
                .attr("fill", "black")
                .merge(labels)
                .transition().duration(500)
                .attr("x", d => x(d.partition) + x.bandwidth() / 2)
                .attr("y", d => y(d.count) - 5)
                .text(d => d.count > 0 ? d.count : ""); 
        }

        // --- Visualisering: Konkordans (Kontekst) ---

        function updateConcordance(word) {
            const listDiv = document.getElementById('concordance-list');
            listDiv.innerHTML = '';
            
            document.getElementById('concordance-title').textContent = `${getGlose('concordanceTitle')} "${word}"`;

            const targetWord = cleanWord(word);
            const contextSize = 5;
            let fragment = document.createDocumentFragment();
            let count = 0;

            globalTokenizedText.forEach((tokenObj, index) => {
                if (tokenObj.word === targetWord) {
                    count++;
                    const startIndex = Math.max(0, index - contextSize);
                    const endIndex = Math.min(globalTokenizedText.length - 1, index + contextSize);

                    const lineDiv = document.createElement('div');
                    lineDiv.className = 'concordance-line';
                    
                    let line = [];

                    for (let i = startIndex; i <= endIndex; i++) {
                        const currentToken = globalTokenizedText[i];
                        const displayWord = currentToken.raw;

                        if (i === index) {
                            line.push(`<span class="highlight">${displayWord}</span>`);
                        } else {
                            line.push(displayWord);
                        }
                    }

                    lineDiv.innerHTML = line.join(' ');
                    fragment.appendChild(lineDiv);
                }
            });
            
            if (count > 0) {
                listDiv.appendChild(fragment);
            } else {
                listDiv.innerHTML = `<p>${getGlose('contextPlaceholder')}</p>`;
            }
        }

        // --- H√∏jre Panel Funktioner ---
        
        function updateRightPanelTexts() {
            const panel = document.getElementById('right-panel');
            if (panel.querySelector('h3')) {
                panel.querySelector('h3').textContent = getGlose('panelTitle');
            }
            
            //document.getElementById('panelToggle').textContent = getGlose('panelToggle');
            
            // Opdater sektionstitler
            const sections = panel.querySelectorAll('.right-panel-section h4');
            if (sections.length >= 3) {
                sections[0].textContent = getGlose('fileInfo');
                sections[1].textContent = getGlose('currentSelection');
                sections[2].textContent = getGlose('statistics');
            }
        }
        
        function updateRightPanelWithAnalysis() {
            const analysisTime = performance.now() - analysisStartTime;
            
            // Beregn totalt antal ord
            let totalWords = 0;
            analysisData.globalList.forEach(word => {
                totalWords += word[1];
            });
            
            // Find mest hyppige ord
            const mostFrequentWord = analysisData.globalList.length > 0 ? 
                `${analysisData.globalList[0][0]} (${analysisData.globalList[0][1]})` : '-';
            
            // Opdater panel indhold
            document.getElementById('panel-file-info').textContent = currentFileName || getGlose('noFileLoaded');
            document.getElementById('panel-word-count').textContent = `${getGlose('totalWords')} ${totalWords}`;
            document.getElementById('panel-partition-count').textContent = `${getGlose('partitions')} ${analysisData.partitionIds.length}`;
            
            document.getElementById('panel-total-words').textContent = `${getGlose('totalUniqueWords')} ${analysisData.globalList.length}`;
            document.getElementById('panel-most-frequent').textContent = `${getGlose('mostFrequentWord')} ${mostFrequentWord}`;
            document.getElementById('panel-analysis-time').textContent = `${getGlose('analysisTime')} ${analysisTime.toFixed(2)}ms`;
        }
        
        function updateRightPanelWithSelectedWord(word, frequency) {
            // Beregn fordeling p√• tv√¶rs af partitioner
            let partitionsWithWord = 0;
            analysisData.partitionIds.forEach(pId => {
                if (analysisData.partitions[pId].get(word) > 0) {
                    partitionsWithWord++;
                }
            });
            
            const distribution = `${partitionsWithWord}/${analysisData.partitionIds.length} partitions`;
            
            document.getElementById('panel-selected-word').textContent = word;
            document.getElementById('panel-word-frequency').textContent = `${getGlose('frequency')} ${frequency}`;
            document.getElementById('panel-partition-distribution').textContent = `${getGlose('distribution')} ${distribution}`;
        }
        
        function toggleRightPanel() {
            const panel = document.getElementById('right-panel');
            panel.classList.toggle('open');
        }

        // --- 4. Event Handlers ---
        
        // Fildialogboks
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            currentFileName = file.name;
            document.getElementById('status').textContent = getGlose('loadingFile') + file.name;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    runAnalysis(e.target.result);
                    // Nulstil barchart/kontekst efter ny fil
                    document.getElementById('chart-title').textContent = getGlose('chartPlaceholder');
                    document.getElementById('concordance-list').innerHTML = `<p>${getGlose('contextPlaceholder')}</p>`;
                    d3.selectAll('.bar').remove();
					 document.getElementById('status').textContent="";
                    
                    // Nulstil h√∏jre panel selection
                    document.getElementById('panel-selected-word').textContent = getGlose('noWordSelected');
                    document.getElementById('panel-word-frequency').textContent = `${getGlose('frequency')} 0`;
                    document.getElementById('panel-partition-distribution').textContent = `${getGlose('distribution')} -`;
                } catch (error) {
                    document.getElementById('status').textContent = `Erreur lors de l'analyse: ${error.message}`; 
                    console.error(error);
                }
            };
            reader.onerror = () => {
                document.getElementById('status').textContent = 'Erreur: Impossible de charger le fichier.';
            };
            reader.readAsText(file, 'UTF-8');
        });

        // Sprogv√¶lger
        document.querySelectorAll('.flag').forEach(flagElement => {
            flagElement.addEventListener('click', (event) => {
                currentLang = event.currentTarget.dataset.lang;
                updateUI();
                if (analysisData.globalList) {
                    displayWordList(analysisData.globalList);
                    // Nulstil til Chart tab efter sprogskift
                    showTab('chart-tab');
                    document.getElementById('chart-title').textContent = getGlose('chartPlaceholder');
                    document.getElementById('concordance-list').innerHTML = `<p>${getGlose('contextPlaceholder')}</p>`;
                }
            });
        });

        // Fane-logik
        document.querySelectorAll('.tab-link').forEach(link => {
            link.addEventListener('click', (event) => {
                const targetTab = event.target.dataset.tab;
                showTab(targetTab);
            });
        });

        function showTab(tabId) {
            // Skjul alle faner og fjern 'active' fra links
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));

            // Vis den valgte fane og marker linket som 'active'
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-link[data-tab="${tabId}"]`).classList.add('active');
        }
        
        // H√∏jre panel toggle
        //document.getElementById('panelToggle').addEventListener('click', toggleRightPanel);

        // Initialisering ved start
        document.addEventListener('DOMContentLoaded', () => {
            initializeChart();
            updateUI();
            showTab('chart-tab'); // Vis standard fane
            
            // Initialiser h√∏jre panel tekster
            document.getElementById('panel-selected-word').textContent = getGlose('noWordSelected');
            document.getElementById('panel-file-info').textContent = getGlose('noFileLoaded');
			
			// I bunden af scriptet, inden '});' for document.addEventListener('DOMContentLoaded', ...

			// Burger menu toggle (tilf√∏jet)
			document.getElementById('burger-btn').addEventListener('click', (event) => {
				event.stopPropagation(); // Forhindrer lukning fra document handleren
				document.getElementById('language-selector').classList.toggle('menu-open');
			});

			// Luk menuen hvis man klikker udenfor (tilf√∏jet)
			document.addEventListener('click', (event) => {
				const burgerContainer = document.getElementById('burger-container');
				const menu = document.getElementById('language-selector');
				
				// Tjekker om klikket var uden for containeren, men kun hvis menuen er √•ben
				if (menu.classList.contains('menu-open') && !burgerContainer.contains(event.target)) {
					menu.classList.remove('menu-open');
				}
			});
        });
    </script>
</body>
</html>
