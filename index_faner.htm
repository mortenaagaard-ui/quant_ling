<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Analyse de Texte Interactive par Partition</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
	
	
        /* --- Generelt Layout --- */
		@font-face {
			font-family: myLato;
			 src: url(font/Lato-Regular.woff); 
			}
			
        body {
            font-family: myLato, sans-serif;
            display: flex;
            flex-direction: column;
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }
        #header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: #f8f8f8;
            border-bottom: 1px solid #ddd;
        }
        #controls {
            padding: 10px 20px 20px;
            background: #f8f8f8;
        }
        #container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* --- Venstre Kolonne (Ordliste) --- */
        #word-list {
            width: 300px;
            overflow-y: scroll;
            border-right: 1px solid #ddd;
            padding: 10px;
            background: #fff;
            flex-shrink: 0;
        }
        .word-item {
            cursor: pointer;
            padding: 4px 8px;
            margin-bottom: 2px;
            border-radius: 3px;
            white-space: nowrap;
        }
        .word-item:hover, .word-item.selected {
            background-color: #e6e6ff;
            color: #333;
            font-weight: bold;
        }
		.word-item:nth-child(even) {
			background-color:DeepSkyBlue;
		}
		
        /* --- Hovedindhold (Faner) --- */
        #main-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #tab-bar {
            display: flex;
            border-bottom: 1px solid #ddd;
            padding-left: 20px;
            background: #f0f0f0;
        }
        .tab-link {
            padding: 10px 15px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-bottom: -1px;
            transition: background-color 0.2s;
        }
        .tab-link:hover {
            background-color: #e0e0e0;
        }
        .tab-link.active {
            background-color: #fff;
            border: 1px solid #ddd;
            border-bottom: 1px solid #fff;
        }
        #tab-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #fff;
        }
        .tab-pane {
            display: none;
        }
        .tab-pane.active {
            display: block;
        }

        /* --- Barchart Styling --- */
        #chart-title {
            text-align: center;
        }
        .bar {
            fill: steelblue;
        }
        .axis path, .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }
        .axis-label {
            font-size: 14px;
        }

        /* --- Konkordans (Kontekst) Styling --- */
        #concordance-list {
            font-family: monospace;
            white-space: pre-wrap;
            line-height: 1.5;
            font-size: 14px;
        }
        .concordance-line {
            padding: 2px 0;
            border-bottom: 1px dotted #eee;
        }
        .highlight {
            color: white;
            background-color: blue;
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: bold;
        }

        /* --- SprogvÃ¦lger (Flags) --- */
        #language-selector {
            display: flex;
            gap: 10px;
        }
        .flag {
            cursor: pointer;
            width: 30px;
            height: 20px; 
            border: 1px solid #ccc;
            opacity: 0.5;
            transition: opacity 0.2s;
            line-height: 20px;
            text-align: center;
            font-size: 20px;
        }
        .flag:hover, .flag.selected {
            opacity: 1;
            border: 1px solid #333;
        }
    </style>
</head>
<body>

    <div id="header">
        <h2 id="app-title"></h2>
        <div id="language-selector">
            <span class="flag" data-lang="fr">ðŸ‡«ðŸ‡·</span>
            <span class="flag" data-lang="en">ðŸ‡¬ðŸ‡§</span>
            <span class="flag" data-lang="da">ðŸ‡©ðŸ‡°</span>
        </div>
    </div>
    
    <div id="controls">
        <input type="file" id="fileInput" accept=".txt">
        <p id="status"></p>
    </div>

    <div id="container">
        <div id="word-list">
            <p></p>
        </div>
        
        <div id="main-view">
            <div id="tab-bar">
                <a class="tab-link active" data-tab="chart-tab"></a>
                <a class="tab-link" data-tab="context-tab"></a>
            </div>
            <div id="tab-content">
                <div id="chart-tab" class="tab-pane active">
                    <h3 id="chart-title"></h3>
                    <div style="text-align: center;">
                        <svg id="barchart"></svg>
                    </div>
                </div>
                <div id="context-tab" class="tab-pane">
                    <h3 id="concordance-title"></h3>
                    <div id="concordance-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. INTERNATIONALISERING (i18n) GLOSSARY ---
        const glossary = {
            'fr': { // FranÃ§ais (Default)
                'appTitle': 'Analyse de Texte Interactive',
                'filePrompt': 'Veuillez sÃ©lectionner un fichier texte (.txt) pour dÃ©marrer l\'analyse.',
                'loadingFile': 'Chargement du fichier : ',
                'analysisComplete': 'Analyse terminÃ©e. {0} mots uniques trouvÃ©s dans {1} partitions.',
                'listPlaceholder': 'Veuillez charger un fichier.',
                'tab1': 'DÃ©compte par Partition',
                'tab2': 'Affichage en Contexte',
                'chartPlaceholder': 'Cliquez sur un mot dans la liste pour voir sa distribution.',
                'chartTitlePrefix': 'Distribution du mot :',
                'concordanceTitle': 'Occurrences du mot en contexte:',
                'contextPlaceholder': 'SÃ©lectionnez un mot pour voir son contexte.',
                'yAxisLabel': 'Nombre d\'occurrences par partition',
                'wordListTitle': 'Mots (FrÃ©quence globale)',
                'introPartition': 'INTRO'
            },
            'en': {
                'appTitle': 'Interactive Text Analysis',
                'filePrompt': 'Please select a text file (.txt) to start the analysis.',
                'loadingFile': 'Loading file: ',
                'analysisComplete': 'Analysis complete. {0} unique words found in {1} partitions.',
                'listPlaceholder': 'Please load a file.',
                'tab1': 'Count per Partition',
                'tab2': 'Context View',
                'chartPlaceholder': 'Click on a word in the list to see its distribution.',
                'chartTitlePrefix': 'Word distribution:',
                'concordanceTitle': 'Word occurrences in context:',
                'contextPlaceholder': 'Select a word to view its context.',
                'yAxisLabel': 'Number of occurrences per partition',
                'wordListTitle': 'Words (Global Frequency)',
                'introPartition': 'INTRO'
            },
            'da': {
                'appTitle': 'Interaktiv Tekstanalyse',
                'filePrompt': 'VÃ¦lg venligst en tekstfil (.txt) for at starte analysen.',
                'loadingFile': 'IndlÃ¦ser fil: ',
                'analysisComplete': 'Analyse fuldfÃ¸rt. {0} unikke ord fundet i {1} partitioner.',
                'listPlaceholder': 'IndlÃ¦s venligst en fil.',
                'tab1': 'OptÃ¦lling af ord pr partition',
                'tab2': 'Visning af ord i kontekst',
                'chartPlaceholder': 'Klik pÃ¥ et ord i listen for at se dets fordeling.',
                'chartTitlePrefix': 'Fordeling af ordet:',
                'concordanceTitle': 'Forekomster af ordet i kontekst:',
                'contextPlaceholder': 'VÃ¦lg et ord for at se dets kontekst.',
                'yAxisLabel': 'Antal forekomster pr. partition',
                'wordListTitle': 'Ord (Global frekvens)',
                'introPartition': 'INTRO'
            }
        };
        
        let currentLang = 'fr'; // Fransk er standard
        let analysisData = {}; // Global datastruktur
        let globalTokenizedText = []; // Global liste til Konkordans

        // Funktion til dynamisk at hente og indsÃ¦tte gloser
        function getGlose(key, ...params) {
            let text = glossary[currentLang][key] || glossary['fr'][key] || `MISSING_GLOSSARY_KEY: ${key}`;
            params.forEach((param, index) => {
                text = text.replace(`{${index}}`, param);
            });
            return text;
        }

        // Funktion til at opdatere alle UI tekster
        function updateUI() {
            document.title = getGlose('appTitle');
            document.getElementById('app-title').textContent = getGlose('appTitle');
            document.getElementById('status').textContent = getGlose('filePrompt');
            document.getElementById('word-list').querySelector('p').textContent = getGlose('listPlaceholder');
            
            // Opdater fanenavne
            document.querySelector('.tab-link[data-tab="chart-tab"]').textContent = getGlose('tab1');
            document.querySelector('.tab-link[data-tab="context-tab"]').textContent = getGlose('tab2');

            // Opdater Y-aksens label (hvis chart er initialiseret)
            d3.select(".y-axis-label").text(getGlose('yAxisLabel'));

            // Opdater titler i faner
            document.getElementById('chart-title').textContent = getGlose('chartPlaceholder');
            document.getElementById('concordance-title').textContent = getGlose('concordanceTitle');
            document.getElementById('concordance-list').innerHTML = `<p>${getGlose('contextPlaceholder')}</p>`;


            const wordListTitle = document.getElementById('word-list').querySelector('h4');
            if (wordListTitle) wordListTitle.textContent = getGlose('wordListTitle');

            // Opdater valgt flag
            document.querySelectorAll('.flag').forEach(flag => {
                flag.classList.remove('selected');
                if (flag.dataset.lang === currentLang) {
                    flag.classList.add('selected');
                }
            });
        }
        
        // --- 2. D3.js Initialisering og Globaler ---
        
        // **FEJL RETTELSE:** Margin erklÃ¦res fÃ¸r brug.
        const margin = { top: 20, right: 30, bottom: 80, left: 60 };
        const w_chart = 600; 
        const h_chart = 400; 

        const fileInput = document.getElementById('fileInput');
        
        // D3 SVG-opsÃ¦tning
        const svg = d3.select("#barchart")
            .attr("width", w_chart + margin.left + margin.right)
            .attr("height", h_chart + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        let x, y, xAxis, yAxis;
        
        function initializeChart() {
            x = d3.scaleBand().range([0, w_chart]).padding(0.1);
            y = d3.scaleLinear().range([h_chart, 0]);

            xAxis = svg.append("g")
                .attr("class", "x-axis axis")
                .attr("transform", `translate(0,${h_chart})`);

            yAxis = svg.append("g")
                .attr("class", "y-axis axis");
            
            svg.append("text")
                .attr("class", "y-axis-label axis-label")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (h_chart / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text(getGlose('yAxisLabel')); 
        }

        // --- 3. Dataanalyse og Visualisering ---
        
        // Global funktion til at rense ord til tÃ¦lling
        function cleanWord(word) {
            // Fjerner alt undtagen bogstaver, tal, og apostrof
            return word.replace(/[^a-zÃ¦Ã¸Ã¥A-ZÃ†Ã˜Ã…0-9']/g, '').toLowerCase();
        }

        function runAnalysis(text) {
            // 1. Tokenisering for Konkordans: Bevarer ordets originale form og rÃ¦kkefÃ¸lge
            // Matches ord ([a-zÃ¦Ã¸Ã¥A-ZÃ†Ã˜Ã…0-9']+) ELLER ikke-ord (alt andet end mellemrum) separat
            const tokenRegex = /([a-zÃ¦Ã¸Ã¥A-ZÃ†Ã˜Ã…0-9']+|[^a-zÃ¦Ã¸Ã¥A-ZÃ†Ã˜Ã…0-9'\s]+)/g;
            const cleanTextForConcordance = text.replace(/<[^>]*>/g, ' '); // Fjern kun tags fÃ¸r tokenisering
            const rawTokens = cleanTextForConcordance.match(tokenRegex) || [];

            globalTokenizedText = rawTokens.map(token => ({
                word: cleanWord(token), // Rengjort for match
                raw: token // Original form til visning
            }));
            
            // 2. Partitionering for Barchart: Samme som fÃ¸r
            const partitionRegex = /(<[^>]*>)/g;
            const segments = text.split(partitionRegex).filter(s => s.trim().length > 0);

            let currentPartition = getGlose('introPartition');
            const partitionContents = {};

            segments.forEach(segment => {
                if (segment.match(partitionRegex)) {
                    currentPartition = segment.slice(1, -1).trim();
                } else {
                    partitionContents[currentPartition] = (partitionContents[currentPartition] || "") + " " + segment;
                }
            });

            const globalWordFrequencies = new Map();
            const partitionWordFrequencies = {};
            const partitionIds = Object.keys(partitionContents);

            partitionIds.forEach(pId => {
                const words = partitionContents[pId].split(/\s+/).map(cleanWord).filter(w => w.length > 0);
                partitionWordFrequencies[pId] = new Map();

                words.forEach(word => {
                    partitionWordFrequencies[pId].set(word, (partitionWordFrequencies[pId].get(word) || 0) + 1);
                    globalWordFrequencies.set(word, (globalWordFrequencies.get(word) || 0) + 1);
                });
            });

            // Sorter global liste
            const sortedGlobalWords = Array.from(globalWordFrequencies.entries());
            sortedGlobalWords.sort((a, b) => {
                const frequencyDiff = b[1] - a[1];
                if (frequencyDiff !== 0) return frequencyDiff;
                return a[0].localeCompare(b[0]);
            });

            // Gem data
            analysisData = {
                globalList: sortedGlobalWords,
                partitions: partitionWordFrequencies,
                partitionIds: partitionIds
            };

            displayWordList(analysisData.globalList);
            document.getElementById('status').textContent = getGlose('analysisComplete', sortedGlobalWords.length, partitionIds.length);
        }

        // --- Visualisering: Ordliste og Barchart (fra tidligere) ---

        function displayWordList(sortedList) {
            const listDiv = d3.select("#word-list");
            listDiv.html(`<h4 style="margin-top: 0;">${getGlose('wordListTitle')}</h4>`); 

            listDiv.selectAll(".word-item")
                .data(sortedList)
                .join("div")
                .attr("class", "word-item")
                .text(d => `${d[0]} (${d[1]})`)
                .on("click", (event, d) => {
                    const word = d[0];
                    d3.selectAll('.word-item').classed('selected', false);
                    d3.select(event.currentTarget).classed('selected', true);
                    
                    // Opdater begge faner ved klik
                    updateBarchart(word);
                    updateConcordance(word);
                });
        }

        function updateBarchart(word) {
            document.getElementById('chart-title').textContent = `${getGlose('chartTitlePrefix')} "${word}"`;

            const chartData = analysisData.partitionIds.map(pId => {
                const count = analysisData.partitions[pId].get(word) || 0;
                return { partition: pId, count: count };
            });

            x.domain(chartData.map(d => d.partition));
            y.domain([0, d3.max(chartData, d => d.count) * 1.05]);

            xAxis.transition().duration(500).call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end");

            yAxis.transition().duration(500).call(d3.axisLeft(y).ticks(5).tickFormat(d3.format("d")));

            const bars = svg.selectAll(".bar").data(chartData, d => d.partition);
            bars.exit().remove();

            bars.enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.partition))
                .attr("y", h_chart) 
                .attr("width", x.bandwidth())
                .attr("height", 0) 
                .merge(bars)
                .transition().duration(500)
                .attr("x", d => x(d.partition))
                .attr("y", d => y(d.count))
                .attr("width", x.bandwidth())
                .attr("height", d => h_chart - y(d.count));
            
            const labels = svg.selectAll(".bar-label").data(chartData, d => d.partition);
            labels.exit().remove();

            labels.enter().append("text")
                .attr("class", "bar-label")
                .attr("text-anchor", "middle")
                .attr("fill", "black")
                .merge(labels)
                .transition().duration(500)
                .attr("x", d => x(d.partition) + x.bandwidth() / 2)
                .attr("y", d => y(d.count) - 5)
                .text(d => d.count > 0 ? d.count : ""); 
        }

        // --- Visualisering: Konkordans (Kontekst) ---

        function updateConcordance(word) {
            const listDiv = document.getElementById('concordance-list');
            listDiv.innerHTML = '';
            
            document.getElementById('concordance-title').textContent = `${getGlose('concordanceTitle')} "${word}"`;

            const targetWord = cleanWord(word);
            const contextSize = 5;
            let fragment = document.createDocumentFragment();
            let count = 0;

            globalTokenizedText.forEach((tokenObj, index) => {
                if (tokenObj.word === targetWord) {
                    count++;
                    const startIndex = Math.max(0, index - contextSize);
                    const endIndex = Math.min(globalTokenizedText.length - 1, index + contextSize);

                    const lineDiv = document.createElement('div');
                    lineDiv.className = 'concordance-line';
                    
                    let line = [];

                    for (let i = startIndex; i <= endIndex; i++) {
                        const currentToken = globalTokenizedText[i];
                        const displayWord = currentToken.raw;

                        if (i === index) {
                            line.push(`<span class="highlight">${displayWord}</span>`);
                        } else {
                            line.push(displayWord);
                        }
                    }

                    lineDiv.innerHTML = line.join(' ');
                    fragment.appendChild(lineDiv);
                }
            });
            
            if (count > 0) {
                listDiv.appendChild(fragment);
            } else {
                listDiv.innerHTML = `<p>${getGlose('contextPlaceholder')}</p>`;
            }
        }


        // --- 4. Event Handlers ---
        
        // Fildialogboks
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('status').textContent = getGlose('loadingFile') + file.name;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    runAnalysis(e.target.result);
                    // Nulstil barchart/kontekst efter ny fil
                    document.getElementById('chart-title').textContent = getGlose('chartPlaceholder');
                    document.getElementById('concordance-list').innerHTML = `<p>${getGlose('contextPlaceholder')}</p>`;
                    d3.selectAll('.bar').remove();
                } catch (error) {
                    document.getElementById('status').textContent = `Erreur lors de l'analyse: ${error.message}`; 
                    console.error(error);
                }
            };
            reader.onerror = () => {
                document.getElementById('status').textContent = 'Erreur: Impossible de charger le fichier.';
            };
            reader.readAsText(file, 'UTF-8');
        });

        // SprogvÃ¦lger
        document.querySelectorAll('.flag').forEach(flagElement => {
            flagElement.addEventListener('click', (event) => {
                currentLang = event.currentTarget.dataset.lang;
                updateUI();
                if (analysisData.globalList) {
                    displayWordList(analysisData.globalList);
                    // Nulstil til Chart tab efter sprogskift
                    showTab('chart-tab');
                    document.getElementById('chart-title').textContent = getGlose('chartPlaceholder');
                    document.getElementById('concordance-list').innerHTML = `<p>${getGlose('contextPlaceholder')}</p>`;
                }
            });
        });

        // Fane-logik
        document.querySelectorAll('.tab-link').forEach(link => {
            link.addEventListener('click', (event) => {
                const targetTab = event.target.dataset.tab;
                showTab(targetTab);
            });
        });

        function showTab(tabId) {
            // Skjul alle faner og fjern 'active' fra links
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));

            // Vis den valgte fane og marker linket som 'active'
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-link[data-tab="${tabId}"]`).classList.add('active');
        }


        // Initialisering ved start
        document.addEventListener('DOMContentLoaded', () => {
            initializeChart();
            updateUI();
            showTab('chart-tab'); // Vis standard fane
        });
    </script>
</body>
</html>